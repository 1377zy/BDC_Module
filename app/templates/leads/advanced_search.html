{% extends 'base.html' %}

{% block title %}Advanced Lead Search - Auto Dealership BDC{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1 class="h3 mb-0 text-gray-800">Advanced Lead Search</h1>
    </div>
    <div class="col-md-6 text-right">
        <a href="{{ url_for('leads') }}" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Back to Leads
        </a>
        <a href="{{ url_for('view_search_history') }}" class="btn btn-info btn-sm">
            <i class="fas fa-history"></i> Search History
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Search Criteria</h6>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-form">
                        <i class="fas fa-eraser"></i> Clear Form
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="save-search" data-bs-toggle="modal" data-bs-target="#saveSearchModal">
                        <i class="fas fa-save"></i> Save Search
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form id="advanced-search-form" action="{{ url_for('advanced_lead_search') }}" method="get">
                    <div class="row">
                        <!-- Basic Information -->
                        <div class="col-md-4 mb-3">
                            <label for="name">Name</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ search_params.name if search_params else '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="email">Email</label>
                            <input type="email" class="form-control" id="email" name="email" value="{{ search_params.email if search_params else '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="phone">Phone</label>
                            <input type="text" class="form-control" id="phone" name="phone" value="{{ search_params.phone if search_params else '' }}">
                        </div>
                        
                        <!-- Lead Status and Source -->
                        <div class="col-md-4 mb-3">
                            <label for="status">Status</label>
                            <select class="form-select" id="status" name="status" multiple>
                                <option value="">All Statuses</option>
                                <option value="New" {% if search_params and 'New' in search_params.status %}selected{% endif %}>New</option>
                                <option value="Contacted" {% if search_params and 'Contacted' in search_params.status %}selected{% endif %}>Contacted</option>
                                <option value="Qualified" {% if search_params and 'Qualified' in search_params.status %}selected{% endif %}>Qualified</option>
                                <option value="Appointment" {% if search_params and 'Appointment' in search_params.status %}selected{% endif %}>Appointment</option>
                                <option value="Sold" {% if search_params and 'Sold' in search_params.status %}selected{% endif %}>Sold</option>
                                <option value="Lost" {% if search_params and 'Lost' in search_params.status %}selected{% endif %}>Lost</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="source">Lead Source</label>
                            <select class="form-select" id="source" name="source" multiple>
                                <option value="">All Sources</option>
                                <option value="Website" {% if search_params and 'Website' in search_params.source %}selected{% endif %}>Website</option>
                                <option value="Referral" {% if search_params and 'Referral' in search_params.source %}selected{% endif %}>Referral</option>
                                <option value="Walk-in" {% if search_params and 'Walk-in' in search_params.source %}selected{% endif %}>Walk-in</option>
                                <option value="Phone" {% if search_params and 'Phone' in search_params.source %}selected{% endif %}>Phone</option>
                                <option value="Email" {% if search_params and 'Email' in search_params.source %}selected{% endif %}>Email</option>
                                <option value="Social Media" {% if search_params and 'Social Media' in search_params.source %}selected{% endif %}>Social Media</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="created_date_range">Created Date Range</label>
                            <div class="input-group">
                                <input type="date" class="form-control" id="created_from" name="created_from" value="{{ search_params.created_from if search_params else '' }}">
                                <span class="input-group-text">to</span>
                                <input type="date" class="form-control" id="created_to" name="created_to" value="{{ search_params.created_to if search_params else '' }}">
                            </div>
                        </div>
                        
                        <!-- Vehicle Interest -->
                        <div class="col-md-3 mb-3">
                            <label for="vehicle_make">Vehicle Make</label>
                            <input type="text" class="form-control" id="vehicle_make" name="vehicle_make" value="{{ search_params.vehicle_make if search_params else '' }}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="vehicle_model">Vehicle Model</label>
                            <input type="text" class="form-control" id="vehicle_model" name="vehicle_model" value="{{ search_params.vehicle_model if search_params else '' }}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="vehicle_year">Vehicle Year</label>
                            <input type="number" class="form-control" id="vehicle_year" name="vehicle_year" value="{{ search_params.vehicle_year if search_params else '' }}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="new_or_used">New or Used</label>
                            <select class="form-select" id="new_or_used" name="new_or_used">
                                <option value="">Both</option>
                                <option value="New" {% if search_params and search_params.new_or_used == 'New' %}selected{% endif %}>New</option>
                                <option value="Used" {% if search_params and search_params.new_or_used == 'Used' %}selected{% endif %}>Used</option>
                            </select>
                        </div>
                        
                        <!-- Communication History -->
                        <div class="col-md-4 mb-3">
                            <label for="last_contact">Last Contact</label>
                            <select class="form-select" id="last_contact" name="last_contact">
                                <option value="">Any time</option>
                                <option value="1" {% if search_params and search_params.last_contact == '1' %}selected{% endif %}>Today</option>
                                <option value="7" {% if search_params and search_params.last_contact == '7' %}selected{% endif %}>Last 7 days</option>
                                <option value="30" {% if search_params and search_params.last_contact == '30' %}selected{% endif %}>Last 30 days</option>
                                <option value="90" {% if search_params and search_params.last_contact == '90' %}selected{% endif %}>Last 90 days</option>
                                <option value="never" {% if search_params and search_params.last_contact == 'never' %}selected{% endif %}>Never contacted</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="communication_type">Communication Type</label>
                            <select class="form-select" id="communication_type" name="communication_type" multiple>
                                <option value="">All Types</option>
                                <option value="Email" {% if search_params and 'Email' in search_params.communication_type %}selected{% endif %}>Email</option>
                                <option value="SMS" {% if search_params and 'SMS' in search_params.communication_type %}selected{% endif %}>SMS</option>
                                <option value="Call" {% if search_params and 'Call' in search_params.communication_type %}selected{% endif %}>Call</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="has_appointment">Appointment Status</label>
                            <select class="form-select" id="has_appointment" name="has_appointment">
                                <option value="">Any</option>
                                <option value="scheduled" {% if search_params and search_params.has_appointment == 'scheduled' %}selected{% endif %}>Has scheduled appointment</option>
                                <option value="completed" {% if search_params and search_params.has_appointment == 'completed' %}selected{% endif %}>Has completed appointment</option>
                                <option value="none" {% if search_params and search_params.has_appointment == 'none' %}selected{% endif %}>No appointments</option>
                            </select>
                        </div>
                        
                        <!-- Notes Search -->
                        <div class="col-md-12 mb-3">
                            <label for="notes_search">Search in Notes</label>
                            <input type="text" class="form-control" id="notes_search" name="notes_search" value="{{ search_params.notes_search if search_params else '' }}">
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Saved Searches -->
        <div class="card shadow-sm mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Saved Searches</h6>
            </div>
            <div class="card-body">
                {% if saved_searches %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for search in saved_searches %}
                            <tr>
                                <td>{{ search.name }}</td>
                                <td>{{ search.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('advanced_lead_search', saved_search_id=search.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Load Search">
                                            <i class="fas fa-folder-open"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-search" data-search-id="{{ search.id }}" data-bs-toggle="tooltip" title="Delete Search">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No saved searches yet. Use the "Save Search" button to save your search criteria for future use.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Search Results -->
        {% if search_results %}
        <div class="card shadow-sm">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Search Results ({{ search_results|length }} leads found)</h6>
                <div>
                    <a href="{{ url_for('export_search_results') }}" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-file-export"></i> Export Results
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact Info</th>
                                <th>Status</th>
                                <th>Source</th>
                                <th>Vehicle Interest</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lead in search_results %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('view_lead', lead_id=lead.id) }}">
                                        {{ lead.first_name }} {{ lead.last_name }}
                                    </a>
                                </td>
                                <td>
                                    {% if lead.email %}
                                    <div><i class="fas fa-envelope fa-sm text-gray-400"></i> {{ lead.email }}</div>
                                    {% endif %}
                                    {% if lead.phone %}
                                    <div><i class="fas fa-phone fa-sm text-gray-400"></i> {{ lead.phone }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{{ lead.status|lower }}">{{ lead.status }}</span>
                                </td>
                                <td>{{ lead.source }}</td>
                                <td>
                                    {% if lead.vehicle_interests %}
                                    {% for interest in lead.vehicle_interests %}
                                    <div>{{ interest.year }} {{ interest.make }} {{ interest.model }}</div>
                                    {% endfor %}
                                    {% else %}
                                    <span class="text-muted">None specified</span>
                                    {% endif %}
                                </td>
                                <td>{{ lead.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('view_lead', lead_id=lead.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="View Lead">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('edit_lead', lead_id=lead.id) }}" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Edit Lead">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('send_email', lead_id=lead.id) }}" class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip" title="Send Email">
                                            <i class="fas fa-envelope"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Save Search Modal -->
<div class="modal fade" id="saveSearchModal" tabindex="-1" aria-labelledby="saveSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveSearchModalLabel">Save Search</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="save-search-form" action="{{ url_for('save_search') }}" method="post">
                    <div class="mb-3">
                        <label for="search_name" class="form-label">Search Name</label>
                        <input type="text" class="form-control" id="search_name" name="search_name" required>
                    </div>
                    <input type="hidden" id="search_params" name="search_params" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-save-search">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize multiple select dropdowns
        const multiSelects = document.querySelectorAll('select[multiple]');
        multiSelects.forEach(select => {
            new SlimSelect({
                select: select,
                placeholder: 'Select options'
            });
        });
        
        // Clear form button
        document.getElementById('clear-form').addEventListener('click', function() {
            document.getElementById('advanced-search-form').reset();
            // Also reset SlimSelect dropdowns
            multiSelects.forEach(select => {
                const slimSelect = SlimSelect.getSlimSelect(select);
                slimSelect.set([]);
            });
        });
        
        // Save search
        document.getElementById('confirm-save-search').addEventListener('click', function() {
            const form = document.getElementById('advanced-search-form');
            const formData = new FormData(form);
            const searchParams = {};
            
            for (const [key, value] of formData.entries()) {
                if (value) {
                    if (searchParams[key]) {
                        if (!Array.isArray(searchParams[key])) {
                            searchParams[key] = [searchParams[key]];
                        }
                        searchParams[key].push(value);
                    } else {
                        searchParams[key] = value;
                    }
                }
            }
            
            document.getElementById('search_params').value = JSON.stringify(searchParams);
            document.getElementById('save-search-form').submit();
        });
        
        // Delete saved search
        document.querySelectorAll('.delete-search').forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this saved search?')) {
                    const searchId = this.getAttribute('data-search-id');
                    window.location.href = "{{ url_for('delete_saved_search') }}?id=" + searchId;
                }
            });
        });
    });
</script>
{% endblock %}
