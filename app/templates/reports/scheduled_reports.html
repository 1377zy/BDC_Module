{% extends 'base.html' %}

{% block title %}Scheduled Reports - Auto Dealership BDC{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/print.css') }}">
<style>
    .card {
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .frequency-badge {
        font-size: 0.8rem;
    }
    
    .badge-daily {
        background-color: #007bff;
    }
    
    .badge-weekly {
        background-color: #28a745;
    }
    
    .badge-monthly {
        background-color: #6f42c1;
    }
    
    .report-type-icon {
        font-size: 1.5rem;
        margin-right: 10px;
    }
    
    .report-actions {
        white-space: nowrap;
    }
    
    .report-status {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .status-active {
        background-color: #28a745;
    }
    
    .status-inactive {
        background-color: #dc3545;
    }
    
    .archived-report {
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('reports.index') }}">Reports</a></li>
                <li class="breadcrumb-item active" aria-current="page">Scheduled Reports</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-5 fw-bold mb-0"><i class="fas fa-clock"></i> Scheduled Reports</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newReportModal">
                <i class="fas fa-plus me-2"></i> New Scheduled Report
            </button>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-calendar-alt me-2"></i> Your Scheduled Reports
                <div class="float-end">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-light active" id="showActiveBtn">Active</button>
                        <button type="button" class="btn btn-sm btn-light" id="showArchivedBtn">Archived</button>
                        <button type="button" class="btn btn-sm btn-light" id="showAllBtn">All</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if scheduled_reports %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Status</th>
                                <th>Report Name</th>
                                <th>Type</th>
                                <th>Frequency</th>
                                <th>Recipients</th>
                                <th>Last Sent</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in scheduled_reports %}
                            <tr class="report-row {% if report.archived %}archived-report{% else %}active-report{% endif %}">
                                <td>
                                    <span class="report-status {% if report.active %}status-active{% else %}status-inactive{% endif %}" 
                                          title="{{ 'Active' if report.active else 'Inactive' }}"></span>
                                    {% if report.archived %}
                                    <span class="badge bg-secondary ms-1" title="Archived">A</span>
                                    {% endif %}
                                </td>
                                <td>{{ report.name }}</td>
                                <td>
                                    <span class="report-type-icon">
                                        {% if report.report_type == 'inventory' %}
                                            <i class="fas fa-car text-primary" title="Inventory Report"></i>
                                        {% elif report.report_type == 'leads' %}
                                            <i class="fas fa-users text-info" title="Leads Report"></i>
                                        {% elif report.report_type == 'sales' %}
                                            <i class="fas fa-dollar-sign text-success" title="Sales Report"></i>
                                        {% elif report.report_type == 'performance' %}
                                            <i class="fas fa-user-tie text-warning" title="Performance Report"></i>
                                        {% elif report.report_type == 'tasks' %}
                                            <i class="fas fa-tasks text-secondary" title="Task Management Report"></i>
                                        {% endif %}
                                    </span>
                                    {{ report.report_type|capitalize }}
                                </td>
                                <td>
                                    <span class="badge frequency-badge badge-{{ report.frequency }}">
                                        {{ report.frequency|capitalize }}
                                        {% if report.frequency == 'weekly' %}
                                            ({{ ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][report.day_of_week] }})
                                        {% elif report.frequency == 'monthly' %}
                                            (Day {{ report.day_of_month }})
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <small>{{ report.recipients|truncate(30) }}</small>
                                </td>
                                <td>
                                    {% if report.last_sent_at %}
                                        <small>{{ report.last_sent_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    {% else %}
                                        <small class="text-muted">Never</small>
                                    {% endif %}
                                </td>
                                <td class="report-actions">
                                    <a href="{{ url_for('reports.edit_scheduled_report', report_id=report.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('reports.toggle_scheduled_report', report_id=report.id) }}" class="btn btn-sm {% if report.active %}btn-outline-danger{% else %}btn-outline-success{% endif %}">
                                        <i class="fas {% if report.active %}fa-pause{% else %}fa-play{% endif %}"></i>
                                    </a>
                                    <a href="{{ url_for('reports.send_scheduled_report_now', report_id=report.id) }}" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-paper-plane"></i>
                                    </a>
                                    {% if report.archived and report.archive_path %}
                                    <a href="{{ url_for('reports.download_archived_report', report_id=report.id) }}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    {% endif %}
                                    <a href="{{ url_for('reports.delete_scheduled_report', report_id=report.id) }}" class="btn btn-sm btn-outline-danger" 
                                       onclick="return confirm('Are you sure you want to delete this scheduled report?');">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> You don't have any scheduled reports yet. Click the "New Scheduled Report" button to create one.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- New Scheduled Report Modal -->
<div class="modal fade" id="newReportModal" tabindex="-1" aria-labelledby="newReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="newReportModalLabel"><i class="fas fa-plus-circle me-2"></i> Create New Scheduled Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('reports.create_scheduled_report') }}">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Report Name</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="report_type" class="form-label">Report Type</label>
                                <select class="form-select" id="report_type" name="report_type" required>
                                    <option value="">Select a report type</option>
                                    <option value="inventory">Inventory Report</option>
                                    <option value="leads">Leads Report</option>
                                    <option value="sales">Sales Report</option>
                                    <option value="performance">Performance Report</option>
                                    <option value="tasks">Task Management Report</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="frequency" class="form-label">Frequency</label>
                                <select class="form-select" id="frequency" name="frequency" required>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 weekly-options d-none">
                            <div class="mb-3">
                                <label for="day_of_week" class="form-label">Day of Week</label>
                                <select class="form-select" id="day_of_week" name="day_of_week">
                                    <option value="0">Monday</option>
                                    <option value="1">Tuesday</option>
                                    <option value="2">Wednesday</option>
                                    <option value="3">Thursday</option>
                                    <option value="4">Friday</option>
                                    <option value="5">Saturday</option>
                                    <option value="6">Sunday</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 monthly-options d-none">
                            <div class="mb-3">
                                <label for="day_of_month" class="form-label">Day of Month</label>
                                <select class="form-select" id="day_of_month" name="day_of_month">
                                    {% for day in range(1, 32) %}
                                    <option value="{{ day }}">{{ day }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="time_of_day" class="form-label">Time of Day</label>
                                <input type="time" class="form-control" id="time_of_day" name="time_of_day" value="08:00" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="format" class="form-label">Format</label>
                                <select class="form-select" id="format" name="format" required>
                                    <option value="pdf">PDF</option>
                                    <option value="csv">CSV</option>
                                    <option value="excel">Excel</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="date_range" class="form-label">Date Range</label>
                                <select class="form-select" id="date_range" name="date_range" required>
                                    <option value="last_7_days">Last 7 Days</option>
                                    <option value="last_30_days" selected>Last 30 Days</option>
                                    <option value="last_90_days">Last 90 Days</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3 custom-date-range d-none">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="custom_start_date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="custom_start_date" name="custom_start_date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="custom_end_date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="custom_end_date" name="custom_end_date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="template_id" class="form-label">Report Template</label>
                        <div class="input-group">
                            <select class="form-select" id="template_id" name="template_id">
                                <option value="">Default Template</option>
                                <!-- Templates will be populated dynamically based on report type -->
                            </select>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" id="preview-template-btn" disabled>
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                            </div>
                        </div>
                        <small class="text-muted">Select a template to customize the appearance of your report. <a href="{{ url_for('reports.report_templates') }}" target="_blank">Manage Templates</a></small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="recipients" class="form-label">Recipients (comma-separated email addresses)</label>
                        <textarea class="form-control" id="recipients" name="recipients" rows="2" required></textarea>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="include_charts" name="include_charts" checked>
                        <label class="form-check-label" for="include_charts">Include Charts and Visualizations</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" id="previewReportBtn">
                        <i class="fas fa-eye me-1"></i> Preview Report
                    </button>
                    <button type="submit" class="btn btn-primary">Create Scheduled Report</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/print-reports.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Show/hide frequency options based on selection
        const frequencySelect = document.getElementById('frequency');
        const weeklyOptions = document.querySelector('.weekly-options');
        const monthlyOptions = document.querySelector('.monthly-options');
        
        frequencySelect.addEventListener('change', function() {
            if (this.value === 'weekly') {
                weeklyOptions.classList.remove('d-none');
                monthlyOptions.classList.add('d-none');
            } else if (this.value === 'monthly') {
                weeklyOptions.classList.add('d-none');
                monthlyOptions.classList.remove('d-none');
            } else {
                weeklyOptions.classList.add('d-none');
                monthlyOptions.classList.add('d-none');
            }
        });
        
        // Show/hide custom date range options
        const dateRangeSelect = document.getElementById('date_range');
        const customDateRange = document.querySelector('.custom-date-range');
        
        dateRangeSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateRange.classList.remove('d-none');
            } else {
                customDateRange.classList.add('d-none');
            }
        });
        
        // Preview report functionality
        const previewReportBtn = document.getElementById('previewReportBtn');
        
        previewReportBtn.addEventListener('click', function() {
            // Create a temporary form for preview submission
            const previewForm = document.createElement('form');
            previewForm.method = 'POST';
            previewForm.action = "{{ url_for('reports.preview_scheduled_report') }}";
            previewForm.target = '_blank'; // Open in new tab
            
            // Get form values
            const reportType = document.getElementById('report_type').value;
            const dateRange = document.getElementById('date_range').value;
            const includeCharts = document.getElementById('include_charts').checked;
            const templateId = document.getElementById('template_id').value;
            
            // Add report type input
            const reportTypeInput = document.createElement('input');
            reportTypeInput.type = 'hidden';
            reportTypeInput.name = 'report_type';
            reportTypeInput.value = reportType;
            previewForm.appendChild(reportTypeInput);
            
            // Add date range input
            const dateRangeInput = document.createElement('input');
            dateRangeInput.type = 'hidden';
            dateRangeInput.name = 'date_range';
            dateRangeInput.value = dateRange;
            previewForm.appendChild(dateRangeInput);
            
            // Add template ID input
            const templateIdInput = document.createElement('input');
            templateIdInput.type = 'hidden';
            templateIdInput.name = 'template_id';
            templateIdInput.value = templateId;
            previewForm.appendChild(templateIdInput);
            
            // Add include charts input
            if (includeCharts) {
                const includeChartsInput = document.createElement('input');
                includeChartsInput.type = 'hidden';
                includeChartsInput.name = 'include_charts';
                includeChartsInput.value = 'on';
                previewForm.appendChild(includeChartsInput);
            }
            
            // Add custom date range inputs if applicable
            if (dateRange === 'custom') {
                const startDateInput = document.createElement('input');
                startDateInput.type = 'hidden';
                startDateInput.name = 'custom_start_date';
                startDateInput.value = document.getElementById('custom_start_date').value;
                previewForm.appendChild(startDateInput);
                
                const endDateInput = document.createElement('input');
                endDateInput.type = 'hidden';
                endDateInput.name = 'custom_end_date';
                endDateInput.value = document.getElementById('custom_end_date').value;
                previewForm.appendChild(endDateInput);
            }
            
            // Add CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken;
            previewForm.appendChild(csrfInput);
            
            // Submit the form
            document.body.appendChild(previewForm);
            previewForm.submit();
            document.body.removeChild(previewForm);
        });
        
        // Filter reports
        const showActiveBtn = document.getElementById('showActiveBtn');
        const showArchivedBtn = document.getElementById('showArchivedBtn');
        const showAllBtn = document.getElementById('showAllBtn');
        const reportRows = document.querySelectorAll('.report-row');
        
        showActiveBtn.addEventListener('click', function() {
            reportRows.forEach(function(row) {
                if (row.classList.contains('active-report')) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        showArchivedBtn.addEventListener('click', function() {
            reportRows.forEach(function(row) {
                if (row.classList.contains('archived-report')) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        showAllBtn.addEventListener('click', function() {
            reportRows.forEach(function(row) {
                row.style.display = '';
            });
        });
        
        // Load templates based on report type
        const reportTypeSelect = document.getElementById('report_type');
        const templateSelect = document.getElementById('template_id');
        
        reportTypeSelect.addEventListener('change', function() {
            loadTemplatesForReportType(this.value);
        });
        
        function loadTemplatesForReportType(reportType) {
            if (!reportType) return;
            
            // Clear current options except the default
            while (templateSelect.options.length > 1) {
                templateSelect.remove(1);
            }
            
            // Disable preview button until a template is selected
            document.getElementById('preview-template-btn').disabled = true;
            
            // Fetch templates for this report type
            fetch(`/reports/templates/for_type/${reportType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        data.templates.forEach(template => {
                            const option = document.createElement('option');
                            option.value = template.id;
                            option.text = template.name + (template.is_default ? ' (Default)' : '');
                            templateSelect.appendChild(option);
                            
                            // If this is a default template, select it automatically
                            if (template.is_default) {
                                option.selected = true;
                                document.getElementById('preview-template-btn').disabled = false;
                            }
                        });
                        
                        // If no default template was found, check if we should select one
                        if (!templateSelect.value) {
                            // Try to get the default template for this report type
                            fetch(`/reports/templates/default/${reportType}`)
                                .then(response => response.json())
                                .then(defaultData => {
                                    if (defaultData.success && defaultData.has_default) {
                                        // Find and select the default template
                                        for (let i = 0; i < templateSelect.options.length; i++) {
                                            if (templateSelect.options[i].value == defaultData.template.id) {
                                                templateSelect.options[i].selected = true;
                                                document.getElementById('preview-template-btn').disabled = false;
                                                break;
                                            }
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error('Error loading default template:', error);
                                });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading templates:', error);
                });
        }
        
        // Enable/disable preview button based on template selection
        templateSelect.addEventListener('change', function() {
            const previewBtn = document.getElementById('preview-template-btn');
            previewBtn.disabled = !this.value;
        });
        
        // Preview template button functionality
        document.getElementById('preview-template-btn').addEventListener('click', function() {
            const templateId = templateSelect.value;
            if (templateId) {
                window.open(`/reports/preview-template/${templateId}`, '_blank');
            }
        });
        
        // Load templates for initial report type
        if (reportTypeSelect.value) {
            loadTemplatesForReportType(reportTypeSelect.value);
        }
    });
</script>
{% endblock %}
