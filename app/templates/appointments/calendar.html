{% extends 'base.html' %}

{% block title %}Appointment Calendar - Auto Dealership BDC{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css">
<style>
    .fc-event {
        cursor: pointer;
    }
    .fc-event-title {
        font-weight: bold;
    }
    .appointment-confirmed {
        background-color: #28a745;
        border-color: #28a745;
    }
    .appointment-pending {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #212529;
    }
    .appointment-cancelled {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    .appointment-completed {
        background-color: #17a2b8;
        border-color: #17a2b8;
    }
    .appointment-no-show {
        background-color: #6c757d;
        border-color: #6c757d;
    }
    .appointment-rescheduled {
        background-color: #fd7e14;
        border-color: #fd7e14;
    }
    .fc-day-today {
        background-color: rgba(var(--bs-primary-rgb), 0.1) !important;
    }
    .calendar-container {
        height: 800px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1 class="display-5 fw-bold"><i class="fas fa-calendar"></i> Appointment Calendar</h1>
    </div>
    <div class="col-md-6 text-md-end">
        <div class="btn-group">
            <a href="{{ url_for('add_appointment') }}" class="btn btn-outline-primary">
                <i class="fas fa-plus"></i> Schedule Appointment
            </a>
            <a href="{{ url_for('appointments') }}" class="btn btn-outline-secondary">
                <i class="fas fa-list"></i> List View
            </a>
            <button id="print-calendar" class="btn btn-outline-info">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-9 mb-3">
                        <div class="btn-group">
                            <button id="today-button" class="btn btn-outline-primary">Today</button>
                            <button id="prev-button" class="btn btn-outline-secondary">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button id="next-button" class="btn btn-outline-secondary">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="btn-group ms-3">
                            <button id="month-view" class="btn btn-outline-secondary active">Month</button>
                            <button id="week-view" class="btn btn-outline-secondary">Week</button>
                            <button id="day-view" class="btn btn-outline-secondary">Day</button>
                            <button id="list-view" class="btn btn-outline-secondary">List</button>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input filter-status" type="checkbox" id="filter-confirmed" value="Confirmed" checked>
                            <label class="form-check-label" for="filter-confirmed">
                                <span class="badge bg-success">Confirmed</span>
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input filter-status" type="checkbox" id="filter-pending" value="Pending" checked>
                            <label class="form-check-label" for="filter-pending">
                                <span class="badge bg-warning text-dark">Pending</span>
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input filter-status" type="checkbox" id="filter-completed" value="Completed" checked>
                            <label class="form-check-label" for="filter-completed">
                                <span class="badge bg-info">Completed</span>
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input filter-status" type="checkbox" id="filter-cancelled" value="Cancelled">
                            <label class="form-check-label" for="filter-cancelled">
                                <span class="badge bg-danger">Cancelled</span>
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input filter-status" type="checkbox" id="filter-no-show" value="No-Show">
                            <label class="form-check-label" for="filter-no-show">
                                <span class="badge bg-secondary">No-Show</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-9">
        <div class="card shadow-sm">
            <div class="card-body calendar-container p-0">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-info-circle me-1"></i> Today's Appointments
            </div>
            <div class="card-body">
                <h3 class="text-center mb-3">{{ today.strftime('%A, %b %d, %Y') }}</h3>
                
                {% if today_appointments %}
                <div class="list-group">
                    {% for appointment in today_appointments %}
                    <a href="{{ url_for('view_appointment', appointment_id=appointment.id) }}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">
                                {% if appointment.time is string %}
                                    {{ appointment.time }}
                                {% else %}
                                    {{ appointment.time.strftime('%I:%M %p') }}
                                {% endif %}
                            </h6>
                            <span class="badge bg-{{ appointment.status|lower|replace(' ', '-') }}">{{ appointment.status }}</span>
                        </div>
                        <p class="mb-1">{{ appointment.lead.first_name }} {{ appointment.lead.last_name }}</p>
                        {% if appointment.vehicle_interest %}
                        <small class="text-muted">{{ appointment.vehicle_interest }}</small>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-calendar-day me-1"></i> No appointments scheduled for today.
                </div>
                {% endif %}
                
                <div class="d-grid gap-2 mt-3">
                    <a href="{{ url_for('add_appointment') }}" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> Schedule New
                    </a>
                    <a href="{{ url_for('appointments') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-list"></i> List View
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-success text-white">
                <i class="fas fa-chart-pie me-1"></i> Appointment Stats
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="p-3 border rounded">
                            <h3>{{ stats.total_month }}</h3>
                            <p class="mb-0 text-muted">This Month</p>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 border rounded">
                            <h3>{{ stats.total_week }}</h3>
                            <p class="mb-0 text-muted">This Week</p>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 border rounded">
                            <h3>{{ stats.no_show_rate }}%</h3>
                            <p class="mb-0 text-muted">No-Show Rate</p>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 border rounded">
                            <h3>{{ stats.conversion_rate }}%</h3>
                            <p class="mb-0 text-muted">Conversion</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h5>Upcoming Available Slots</h5>
                    <div class="list-group">
                        {% for slot in available_slots %}
                        <a href="{{ url_for('add_appointment', date=slot.date, time=slot.time) }}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-0">{{ slot.day_of_week }}</h6>
                                <small>{{ slot.date }}</small>
                            </div>
                            <small>{{ slot.time }}</small>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Appointment Quick View Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="appointmentModalLabel">Appointment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="appointment-loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading appointment details...</p>
                </div>
                <div id="appointment-details" class="d-none">
                    <div class="mb-3">
                        <label class="form-label">Lead:</label>
                        <p id="appointment-lead" class="form-control"></p>
                        <a href="#" id="appointment-lead-link" class="btn btn-sm btn-outline-primary mt-1">
                            <i class="fas fa-user"></i> View Lead Details
                        </a>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date:</label>
                            <p id="appointment-date" class="form-control"></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Time:</label>
                            <p id="appointment-time" class="form-control"></p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status:</label>
                        <p id="appointment-status" class="form-control"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Vehicle Interest:</label>
                        <p id="appointment-vehicle" class="form-control"></p>
                    </div>
                    <div class="mb-3" id="appointment-notes-container">
                        <label class="form-label">Notes:</label>
                        <div id="appointment-notes" class="p-3 border rounded bg-light"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="btn-group" role="group" id="appointment-actions">
                    <a href="#" id="appointment-view-link" class="btn btn-primary">
                        <i class="fas fa-eye"></i> View Full Details
                    </a>
                    <a href="#" id="appointment-edit-link" class="btn btn-secondary">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                </div>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script>
    // Pass appointments data to the calendar.js file
    const appointmentsData = {{ appointments_json|safe }};
</script>
<script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
{% endblock %}

<!-- Include Quick Add Modal -->
{% include 'appointments/quick_add_modal.html' %}
