{% extends "base.html" %}

{% block title %}Report Templates{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .template-card {
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .template-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .template-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        display: none;
    }
    
    .template-card:hover .template-actions {
        display: block;
    }
    
    .default-badge {
        position: absolute;
        top: 10px;
        left: 10px;
    }
    
    .template-type-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1><i class="fas fa-file-alt me-2"></i> Report Templates</h1>
            <p class="text-muted">Manage templates for your scheduled reports</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="dropdown d-inline-block me-2">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="importExportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-exchange-alt me-2"></i> Import/Export
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="importExportDropdown">
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#importTemplateModal">
                            <i class="fas fa-file-import me-2"></i> Import Template
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkImportModal">
                            <i class="fas fa-file-import me-2"></i> Bulk Import
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkExportModal">
                            <i class="fas fa-file-export me-2"></i> Bulk Export
                        </a>
                    </li>
                </ul>
            </div>
            <a href="{{ url_for('reports.template_analytics') }}" class="btn btn-outline-primary me-2">
                <i class="fas fa-chart-bar me-2"></i> Analytics
            </a>
            <a href="{{ url_for('reports.new_template') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i> New Template
            </a>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-info-circle me-2"></i> About Templates
                </div>
                <div class="card-body">
                    <p>Report templates allow you to customize the appearance of your scheduled reports. You can:</p>
                    <ul>
                        <li>Add custom headers and footers</li>
                        <li>Customize CSS styles</li>
                        <li>Control logo and timestamp display</li>
                        <li>Set default templates for each report type</li>
                    </ul>
                    <p>Templates are applied when scheduled reports are generated and sent to recipients.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs mb-4" id="templateTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab" aria-controls="all" aria-selected="true">All Templates</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab" aria-controls="inventory" aria-selected="false">Inventory</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="leads-tab" data-bs-toggle="tab" data-bs-target="#leads" type="button" role="tab" aria-controls="leads" aria-selected="false">Leads</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab" aria-controls="sales" aria-selected="false">Sales</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab" aria-controls="performance" aria-selected="false">Performance</button>
                </li>
            </ul>
        </div>
    </div>
    
    <div class="tab-content" id="templateTabContent">
        <div class="tab-pane fade show active" id="all" role="tabpanel" aria-labelledby="all-tab">
            <div class="row">
                {% if templates %}
                    {% for template in templates %}
                        <div class="col-md-4 mb-4">
                            <div class="card template-card">
                                {% if template.is_default %}
                                <span class="badge bg-success default-badge">Default</span>
                                {% endif %}
                                <div class="template-actions">
                                    <div class="btn-group">
                                        <a href="{{ url_for('reports.preview_template', template_id=template.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Preview Template">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('reports.edit_template', template_id=template.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Edit Template">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-primary set-default-btn" data-template-id="{{ template.id }}" data-bs-toggle="tooltip" title="Set as Default">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary duplicate-btn" data-template-id="{{ template.id }}" data-bs-toggle="tooltip" title="Duplicate Template">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <a href="{{ url_for('reports.export_template', template_id=template.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Export Template">
                                            <i class="fas fa-file-export"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger delete-template-btn" data-template-id="{{ template.id }}" data-bs-toggle="tooltip" title="Delete Template">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body text-center">
                                    <div class="template-type-icon">
                                        {% if template.report_type == 'inventory' %}
                                            <i class="fas fa-car text-primary"></i>
                                        {% elif template.report_type == 'leads' %}
                                            <i class="fas fa-users text-info"></i>
                                        {% elif template.report_type == 'sales' %}
                                            <i class="fas fa-dollar-sign text-success"></i>
                                        {% elif template.report_type == 'performance' %}
                                            <i class="fas fa-user-tie text-warning"></i>
                                        {% endif %}
                                    </div>
                                    <h5 class="card-title">{{ template.name }}</h5>
                                    <p class="card-text text-muted">{{ template.description|truncate(100) }}</p>
                                    <div class="mt-3">
                                        <span class="badge bg-primary">{{ template.report_type|capitalize }}</span>
                                        <span class="badge bg-secondary">Created {{ template.created_at.strftime('%Y-%m-%d') }}</span>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <small class="text-muted">Created by: {{ template.created_by.name }}</small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No templates found. Click the "New Template" button to create one.
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        
        {% for type in ['inventory', 'leads', 'sales', 'performance'] %}
        <div class="tab-pane fade" id="{{ type }}" role="tabpanel" aria-labelledby="{{ type }}-tab">
            <div class="row">
                {% set found = false %}
                {% for template in templates %}
                    {% if template.report_type == type %}
                        {% set found = true %}
                        <div class="col-md-4 mb-4">
                            <div class="card template-card">
                                {% if template.is_default %}
                                <span class="badge bg-success default-badge">Default</span>
                                {% endif %}
                                <div class="template-actions">
                                    <div class="btn-group">
                                        <a href="{{ url_for('reports.preview_template', template_id=template.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Preview Template">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('reports.edit_template', template_id=template.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Edit Template">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-primary set-default-btn" data-template-id="{{ template.id }}" data-bs-toggle="tooltip" title="Set as Default">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary duplicate-btn" data-template-id="{{ template.id }}" data-bs-toggle="tooltip" title="Duplicate Template">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <a href="{{ url_for('reports.export_template', template_id=template.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Export Template">
                                            <i class="fas fa-file-export"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger delete-template-btn" data-template-id="{{ template.id }}" data-bs-toggle="tooltip" title="Delete Template">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body text-center">
                                    <div class="template-type-icon">
                                        {% if type == 'inventory' %}
                                            <i class="fas fa-car text-primary"></i>
                                        {% elif type == 'leads' %}
                                            <i class="fas fa-users text-info"></i>
                                        {% elif type == 'sales' %}
                                            <i class="fas fa-dollar-sign text-success"></i>
                                        {% elif type == 'performance' %}
                                            <i class="fas fa-user-tie text-warning"></i>
                                        {% endif %}
                                    </div>
                                    <h5 class="card-title">{{ template.name }}</h5>
                                    <p class="card-text text-muted">{{ template.description|truncate(100) }}</p>
                                    <div class="mt-3">
                                        <span class="badge bg-secondary">Created {{ template.created_at.strftime('%Y-%m-%d') }}</span>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <small class="text-muted">Created by: {{ template.created_by.name }}</small>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
                {% if not found %}
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No {{ type }} templates found. Click the "New Template" button to create one.
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Import Template Modal -->
<div class="modal fade" id="importTemplateModal" tabindex="-1" aria-labelledby="importTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importTemplateModalLabel">Import Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('reports.import_template') }}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <p>Import a template from a JSON file. The file should be in the format exported by the BDC Module.</p>
                    <div class="mb-3">
                        <label for="template_file" class="form-label">Template File (JSON)</label>
                        <input type="file" class="form-control" id="template_file" name="template_file" accept=".json" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Export Modal -->
<div class="modal fade" id="bulkExportModal" tabindex="-1" aria-labelledby="bulkExportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkExportModalLabel">Bulk Export Templates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('reports.bulk_export_templates') }}" method="post">
                <div class="modal-body">
                    <p>Select the templates you want to export. The templates will be exported as a single JSON file.</p>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                                <button class="nav-link active" id="v-pills-inventory-tab" data-bs-toggle="pill" data-bs-target="#v-pills-inventory" type="button" role="tab" aria-controls="v-pills-inventory" aria-selected="true">Inventory</button>
                                <button class="nav-link" id="v-pills-leads-tab" data-bs-toggle="pill" data-bs-target="#v-pills-leads" type="button" role="tab" aria-controls="v-pills-leads" aria-selected="false">Leads</button>
                                <button class="nav-link" id="v-pills-sales-tab" data-bs-toggle="pill" data-bs-target="#v-pills-sales" type="button" role="tab" aria-controls="v-pills-sales" aria-selected="false">Sales</button>
                                <button class="nav-link" id="v-pills-performance-tab" data-bs-toggle="pill" data-bs-target="#v-pills-performance" type="button" role="tab" aria-controls="v-pills-performance" aria-selected="false">Performance</button>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="tab-content" id="v-pills-tabContent">
                                <div class="tab-pane fade show active" id="v-pills-inventory" role="tabpanel" aria-labelledby="v-pills-inventory-tab">
                                    {% for template in inventory_templates %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="template_ids" value="{{ template.id }}" id="template-{{ template.id }}">
                                        <label class="form-check-label" for="template-{{ template.id }}">
                                            {{ template.name }}
                                            {% if template.is_default %}<span class="badge bg-success">Default</span>{% endif %}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="tab-pane fade" id="v-pills-leads" role="tabpanel" aria-labelledby="v-pills-leads-tab">
                                    {% for template in leads_templates %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="template_ids" value="{{ template.id }}" id="template-{{ template.id }}">
                                        <label class="form-check-label" for="template-{{ template.id }}">
                                            {{ template.name }}
                                            {% if template.is_default %}<span class="badge bg-success">Default</span>{% endif %}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="tab-pane fade" id="v-pills-sales" role="tabpanel" aria-labelledby="v-pills-sales-tab">
                                    {% for template in sales_templates %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="template_ids" value="{{ template.id }}" id="template-{{ template.id }}">
                                        <label class="form-check-label" for="template-{{ template.id }}">
                                            {{ template.name }}
                                            {% if template.is_default %}<span class="badge bg-success">Default</span>{% endif %}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="tab-pane fade" id="v-pills-performance" role="tabpanel" aria-labelledby="v-pills-performance-tab">
                                    {% for template in performance_templates %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="template_ids" value="{{ template.id }}" id="template-{{ template.id }}">
                                        <label class="form-check-label" for="template-{{ template.id }}">
                                            {{ template.name }}
                                            {% if template.is_default %}<span class="badge bg-success">Default</span>{% endif %}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Export Selected</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Import Modal -->
<div class="modal fade" id="bulkImportModal" tabindex="-1" aria-labelledby="bulkImportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkImportModalLabel">Bulk Import Templates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('reports.bulk_import_templates') }}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <p>Import multiple templates from a single JSON file. The file should be in the format exported by the BDC Module's bulk export feature.</p>
                    <div class="mb-3">
                        <label for="bulk_template_file" class="form-label">Templates File (JSON)</label>
                        <input type="file" class="form-control" id="bulk_template_file" name="bulk_template_file" accept=".json" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Set default template
        $('.set-default-btn').click(function() {
            const templateId = $(this).data('template-id');
            $.ajax({
                url: "{{ url_for('reports.set_default_template') }}",
                type: "POST",
                data: JSON.stringify({
                    template_id: templateId
                }),
                contentType: "application/json",
                success: function(response) {
                    if (response.success) {
                        // Show toast notification
                        showToast('Success', response.message, 'success');
                        // Reload the page to reflect changes
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showToast('Error', response.message, 'danger');
                    }
                },
                error: function() {
                    showToast('Error', 'Failed to set default template', 'danger');
                }
            });
        });
        
        // Duplicate template
        $('.duplicate-btn').click(function() {
            const templateId = $(this).data('template-id');
            $.ajax({
                url: "{{ url_for('reports.duplicate_template') }}",
                type: "POST",
                data: JSON.stringify({
                    template_id: templateId
                }),
                contentType: "application/json",
                success: function(response) {
                    if (response.success) {
                        // Show toast notification
                        showToast('Success', response.message, 'success');
                        // Reload the page to reflect changes
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showToast('Error', response.message, 'danger');
                    }
                },
                error: function() {
                    showToast('Error', 'Failed to duplicate template', 'danger');
                }
            });
        });
        
        // Delete template
        $('.delete-template-btn').click(function() {
            const templateId = $(this).data('template-id');
            if (confirm('Are you sure you want to delete this template?')) {
                $.ajax({
                    url: "{{ url_for('reports.delete_template_api') }}",
                    type: "POST",
                    data: JSON.stringify({
                        template_id: templateId
                    }),
                    contentType: "application/json",
                    success: function(response) {
                        if (response.success) {
                            // Show toast notification
                            showToast('Success', response.message, 'success');
                            // Reload the page to reflect changes
                            setTimeout(function() {
                                location.reload();
                            }, 1000);
                        } else {
                            showToast('Error', response.message, 'danger');
                        }
                    },
                    error: function() {
                        showToast('Error', 'Failed to delete template', 'danger');
                    }
                });
            }
        });
        
        // Function to show toast notifications
        function showToast(title, message, type) {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}:</strong> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                // Create toast container if it doesn't exist
                const container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(container);
            }
            
            $('#toast-container').append(toastHtml);
            const toastElement = $('.toast').last();
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 3000
            });
            toast.show();
        }
        
        // Select all templates of a type
        $('.select-all-btn').click(function() {
            const reportType = $(this).data('report-type');
            $(`#v-pills-${reportType} .form-check-input`).prop('checked', true);
        });
        
        // Deselect all templates of a type
        $('.deselect-all-btn').click(function() {
            const reportType = $(this).data('report-type');
            $(`#v-pills-${reportType} .form-check-input`).prop('checked', false);
        });
        
        // Add select/deselect all buttons to each tab
        ['inventory', 'leads', 'sales', 'performance'].forEach(function(type) {
            const tabContent = $(`#v-pills-${type}`);
            if (tabContent.find('.form-check').length > 0) {
                tabContent.prepend(`
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary select-all-btn" data-report-type="${type}">Select All</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary deselect-all-btn" data-report-type="${type}">Deselect All</button>
                    </div>
                `);
            }
        });
    });
</script>
{% endblock %}
