{% extends "base.html" %}

{% block title %}Lead Segmentation{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Lead Segmentation</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('leads') }}">Leads</a></li>
        <li class="breadcrumb-item active">Segmentation</li>
    </ol>
    
    <div class="row">
        <div class="col-xl-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-layer-group me-1"></i>
                        Segments
                    </div>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createSegmentModal">
                        <i class="fas fa-plus"></i> Create Segment
                    </button>
                </div>
                <div class="card-body">
                    {% if segments %}
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="segmentsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th>Leads</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for segment in segments %}
                                <tr>
                                    <td>{{ segment.name }}</td>
                                    <td>{{ segment.description }}</td>
                                    <td>{{ 'Dynamic' if segment.is_dynamic else 'Static' }}</td>
                                    <td>{{ segment.leads|length }}</td>
                                    <td>{{ segment.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('view_segment', segment_id=segment.id) }}" class="btn btn-sm btn-info">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('edit_segment', segment_id=segment.id) }}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteSegmentModal" data-segment-id="{{ segment.id }}" data-segment-name="{{ segment.name }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No segments have been created yet. Create your first segment to start organizing your leads.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-tags me-1"></i>
                    Interest-Based Segmentation
                </div>
                <div class="card-body">
                    <p>Group leads based on their interests in specific vehicle types, features, or services.</p>
                    <a href="{{ url_for('create_segment', segment_type='interest') }}" class="btn btn-outline-primary">Create Interest Segment</a>
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-dollar-sign me-1"></i>
                    Budget-Based Segmentation
                </div>
                <div class="card-body">
                    <p>Group leads based on their budget range, preferred payment method, or financing options.</p>
                    <a href="{{ url_for('create_segment', segment_type='budget') }}" class="btn btn-outline-primary">Create Budget Segment</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-calendar-alt me-1"></i>
                    Timeline-Based Segmentation
                </div>
                <div class="card-body">
                    <p>Group leads based on their purchase timeline, urgency level, or specific purchase dates.</p>
                    <a href="{{ url_for('create_segment', segment_type='timeline') }}" class="btn btn-outline-primary">Create Timeline Segment</a>
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-sliders-h me-1"></i>
                    Custom Segmentation
                </div>
                <div class="card-body">
                    <p>Create custom segments based on multiple criteria or custom fields that you define.</p>
                    <a href="{{ url_for('create_segment', segment_type='custom') }}" class="btn btn-outline-primary">Create Custom Segment</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-xl-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-cog me-1"></i>
                        Custom Segment Fields
                    </div>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createCustomFieldModal">
                        <i class="fas fa-plus"></i> Add Custom Field
                    </button>
                </div>
                <div class="card-body">
                    {% if custom_fields %}
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="customFieldsTable">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Display Name</th>
                                    <th>Type</th>
                                    <th>Created By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for field in custom_fields %}
                                <tr>
                                    <td>{{ field.name }}</td>
                                    <td>{{ field.display_name }}</td>
                                    <td>{{ field.field_type }}</td>
                                    <td>{{ field.creator.get_full_name() }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('edit_custom_field', field_id=field.id) }}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteCustomFieldModal" data-field-id="{{ field.id }}" data-field-name="{{ field.display_name }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No custom fields have been created yet. Add custom fields to enhance your lead segmentation capabilities.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Segment Modal -->
<div class="modal fade" id="createSegmentModal" tabindex="-1" aria-labelledby="createSegmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createSegmentModalLabel">Create New Segment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('create_segment') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="segmentName" class="form-label">Segment Name</label>
                        <input type="text" class="form-control" id="segmentName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="segmentDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="segmentDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isDynamic" name="is_dynamic" value="1" checked>
                            <label class="form-check-label" for="isDynamic">
                                Dynamic Segment (automatically updates based on criteria)
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Segment Type</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="segment_type" id="interestSegment" value="interest" checked>
                            <label class="form-check-label" for="interestSegment">
                                Interest-Based
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="segment_type" id="budgetSegment" value="budget">
                            <label class="form-check-label" for="budgetSegment">
                                Budget-Based
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="segment_type" id="timelineSegment" value="timeline">
                            <label class="form-check-label" for="timelineSegment">
                                Timeline-Based
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="segment_type" id="customSegment" value="custom">
                            <label class="form-check-label" for="customSegment">
                                Custom (multiple criteria)
                            </label>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> You'll be able to define specific criteria for your segment on the next screen.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Segment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Segment Modal -->
<div class="modal fade" id="deleteSegmentModal" tabindex="-1" aria-labelledby="deleteSegmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteSegmentModalLabel">Delete Segment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the segment "<span id="deleteSegmentName"></span>"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDeleteSegment" class="btn btn-danger">Delete</a>
            </div>
        </div>
    </div>
</div>

<!-- Create Custom Field Modal -->
<div class="modal fade" id="createCustomFieldModal" tabindex="-1" aria-labelledby="createCustomFieldModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createCustomFieldModalLabel">Add Custom Field</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('create_custom_field') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="fieldName" class="form-label">Field Name (system name, no spaces)</label>
                        <input type="text" class="form-control" id="fieldName" name="name" required pattern="[a-zA-Z0-9_]+" title="Only letters, numbers, and underscores allowed">
                    </div>
                    <div class="mb-3">
                        <label for="displayName" class="form-label">Display Name</label>
                        <input type="text" class="form-control" id="displayName" name="display_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="fieldType" class="form-label">Field Type</label>
                        <select class="form-select" id="fieldType" name="field_type" required>
                            <option value="text">Text</option>
                            <option value="number">Number</option>
                            <option value="date">Date</option>
                            <option value="boolean">Yes/No</option>
                            <option value="select">Select (dropdown)</option>
                        </select>
                    </div>
                    <div class="mb-3" id="optionsContainer" style="display: none;">
                        <label for="fieldOptions" class="form-label">Options (one per line)</label>
                        <textarea class="form-control" id="fieldOptions" name="options" rows="4"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Field</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Custom Field Modal -->
<div class="modal fade" id="deleteCustomFieldModal" tabindex="-1" aria-labelledby="deleteCustomFieldModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCustomFieldModalLabel">Delete Custom Field</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the custom field "<span id="deleteFieldName"></span>"?</p>
                <p class="text-danger">This will remove this field from all leads and segments that use it. This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDeleteField" class="btn btn-danger">Delete</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Initialize DataTables
        $('#segmentsTable').DataTable({
            order: [[4, 'desc']] // Sort by created date by default
        });
        
        $('#customFieldsTable').DataTable();
        
        // Show/hide options field based on field type
        $('#fieldType').change(function() {
            if ($(this).val() === 'select') {
                $('#optionsContainer').show();
            } else {
                $('#optionsContainer').hide();
            }
        });
        
        // Set up delete segment modal
        $('#deleteSegmentModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget);
            var segmentId = button.data('segment-id');
            var segmentName = button.data('segment-name');
            
            $('#deleteSegmentName').text(segmentName);
            $('#confirmDeleteSegment').attr('href', "{{ url_for('delete_segment', segment_id=0) }}".replace('0', segmentId));
        });
        
        // Set up delete custom field modal
        $('#deleteCustomFieldModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget);
            var fieldId = button.data('field-id');
            var fieldName = button.data('field-name');
            
            $('#deleteFieldName').text(fieldName);
            $('#confirmDeleteField').attr('href', "{{ url_for('delete_custom_field', field_id=0) }}".replace('0', fieldId));
        });
    });
</script>
{% endblock %}
